# Guia de Configura√ß√£o Completo - AmpliE Chat Central

## üöÄ Configura√ß√£o Inicial

### Pr√©-requisitos
- Node.js 18+
- Conta no Supabase
- Evolution API configurada
- Dom√≠nio com SSL (para produ√ß√£o)

### 1. Vari√°veis de Ambiente

```bash
# Copie o template
cp .env.example .env
```

Configure as seguintes vari√°veis:

```env
# Supabase Configuration
VITE_SUPABASE_URL=https://seu-projeto.supabase.co
VITE_SUPABASE_ANON_KEY=sua-chave-anonima

# Evolution API Configuration
VITE_EVOLUTION_API_URL=https://sua-evolution-api.com
VITE_EVOLUTION_API_KEY=sua-chave-evolution
VITE_EVOLUTION_INSTANCE_NAME=sua-instancia
VITE_EVOLUTION_WEBHOOK_URL=https://seu-dominio.com/webhook/evolution-api

# Real-time Configuration (Opcional)
VITE_REALTIME_ENABLED=true
VITE_WEBSOCKET_TIMEOUT=30000
VITE_PRESENCE_ENABLED=true
```

### 2. Primeiro Acesso

1. Execute o projeto: `npm run dev`
2. Acesse `/auth` para fazer login
3. Use o email: `ampliemarketing.mkt@gmail.com`
4. Ap√≥s login, voc√™ ter√° acesso como Super Admin

## üèóÔ∏è Configura√ß√£o do Supabase

### 1. Migra√ß√µes do Banco

Execute as migra√ß√µes na ordem cronol√≥gica:

```sql
-- Aplicar todas as migra√ß√µes da pasta supabase/migrations/
-- Importante: manter a ordem cronol√≥gica dos arquivos
```

### 2. Edge Functions

Deploy das seguintes Edge Functions:

#### A. Realtime Gateway
```bash
supabase functions deploy realtime-gateway
```
**Funcionalidade**: Gateway WebSocket para comunica√ß√£o bidirecional

#### B. Webhook Evolution API
```bash
supabase functions deploy whatsapp-webhook-evolution
```
**Funcionalidade**: Recebimento otimizado de webhooks da Evolution API

#### C. Message Processor
```bash
supabase functions deploy whatsapp-message-processor
```
**Funcionalidade**: Processamento ass√≠ncrono de mensagens

#### D. Queue Processor
```bash
supabase functions deploy chatbot-queue-processor
```
**Funcionalidade**: Processamento de filas com Dead Letter Queue

#### E. Chatbot Engine
```bash
supabase functions deploy chatbot-engine
```
**Funcionalidade**: Engine de processamento de chatbots

### 3. Configura√ß√£o de Seguran√ßa (RLS)

Verifique se as pol√≠ticas RLS est√£o ativas:

```sql
-- Verificar RLS ativo em todas as tabelas
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND rowsecurity = false;

-- Se alguma tabela n√£o tiver RLS, ativar:
ALTER TABLE nome_da_tabela ENABLE ROW LEVEL SECURITY;
```

### 4. Configura√ß√£o de Secrets

No painel do Supabase, configure:
- `EVOLUTION_API_URL`
- `EVOLUTION_API_KEY`
- Outras chaves de API de terceiros

## üì± Configura√ß√£o WhatsApp (Evolution API)

### 1. Configura√ß√£o da Evolution API

1. **Obter Credenciais**:
   - URL da API
   - API Key
   - Nome da inst√¢ncia

2. **Configurar Webhook**:
   ```
   URL: https://seu-dominio.com/functions/v1/whatsapp-webhook-evolution
   Eventos: messages.upsert, connection.update
   ```

### 2. Configura√ß√£o no Sistema

1. Acesse "Configura√ß√µes" ‚Üí "WhatsApp"
2. Adicione as credenciais da Evolution API
3. Teste a conex√£o
4. Sincronize as inst√¢ncias dispon√≠veis

### 3. Conectar WhatsApp

1. Na tela de inst√¢ncias, clique em "Conectar"
2. Escaneie o QR Code com WhatsApp Business
3. Aguarde confirma√ß√£o de conex√£o
4. Configure webhook se n√£o estiver autom√°tico

### 4. Teste de Funcionamento

1. Envie uma mensagem de teste via WhatsApp
2. Verifique se aparece no sistema
3. Responda via sistema
4. Confirme recebimento no WhatsApp

## üîß Configura√ß√£o de Setores

### 1. Estrutura Organizacional

1. Acesse "Setores"
2. Crie setores para sua empresa:
   - **Vendas** (capacidade: 5 atendentes)
   - **Suporte** (capacidade: 3 atendentes)
   - **Financeiro** (capacidade: 2 atendentes)

### 2. Configura√ß√£o de Capacidade

- **Capacidade M√°xima**: N√∫mero m√°ximo de atendentes simult√¢neos
- **Fila de Espera**: Ativar para setores com alta demanda
- **Hor√°rio de Funcionamento**: Definir hor√°rios de atendimento
- **Transfer√™ncia Autom√°tica**: Configurar regras de transfer√™ncia

### 3. Associa√ß√£o de Usu√°rios

1. Acesse "Usu√°rios"
2. Para cada usu√°rio, defina:
   - Setor principal
   - Setores secund√°rios (opcional)
   - Capacidade individual de atendimento

## ü§ñ Configura√ß√£o de Chatbots

### 1. Criar Primeiro Fluxo

1. Acesse "ChatBot" ‚Üí "Novo Fluxo"
2. Defina nome: "Atendimento Inicial"
3. Configure gatilho: "Nova conversa"

### 2. Estrutura B√°sica do Fluxo

```
[In√≠cio] ‚Üí [Mensagem de Boas-vindas] ‚Üí [Menu de Op√ß√µes] ‚Üí [Condi√ß√µes] ‚Üí [Transfer√™ncia/Resposta]
```

#### A. N√≥ de In√≠cio
- Gatilho: Nova conversa
- Condi√ß√µes: Hor√°rio comercial

#### B. Mensagem de Boas-vindas
```
Ol√°! üëã Bem-vindo √† nossa empresa.
Como posso ajud√°-lo hoje?
```

#### C. Menu de Op√ß√µes
```
Escolha uma op√ß√£o:
1Ô∏è‚É£ Vendas
2Ô∏è‚É£ Suporte
3Ô∏è‚É£ Financeiro
4Ô∏è‚É£ Falar com atendente
```

#### D. Condi√ß√µes de Roteamento
- Se resposta = "1" ‚Üí Transferir para setor Vendas
- Se resposta = "2" ‚Üí Transferir para setor Suporte
- Se resposta = "3" ‚Üí Transferir para setor Financeiro
- Se resposta = "4" ‚Üí Transferir para qualquer agente dispon√≠vel

### 3. Configura√ß√µes Avan√ßadas

#### A. Hor√°rio de Funcionamento
```json
{
  "horarios": {
    "segunda_sexta": "08:00-18:00",
    "sabado": "08:00-12:00",
    "domingo": "fechado"
  },
  "fuso_horario": "America/Sao_Paulo"
}
```

#### B. Mensagem Fora do Hor√°rio
```
Ol√°! üåô Nosso atendimento est√° fechado.
Hor√°rio de funcionamento:
üìÖ Segunda a Sexta: 8h √†s 18h
üìÖ S√°bado: 8h √†s 12h
üìÖ Domingo: Fechado

Deixe sua mensagem que retornaremos assim que poss√≠vel!
```

### 4. Teste do Chatbot

1. Use o "Modo Teste" no editor
2. Simule diferentes cen√°rios
3. Verifique todos os caminhos poss√≠veis
4. Teste transfer√™ncias entre setores
5. Ative apenas ap√≥s testes completos

## üë• Gest√£o de Usu√°rios e Permiss√µes

### 1. Cargos Dispon√≠veis

#### üî¥ Super Admin
- **Permiss√µes**: Acesso total ao sistema
- **Funcionalidades**:
  - Gest√£o de empresas
  - Configura√ß√µes globais
  - Logs de sistema
  - An√°lise de performance

#### üü† Admin
- **Permiss√µes**: Gest√£o completa da empresa
- **Funcionalidades**:
  - Gest√£o de usu√°rios
  - Configura√ß√µes da empresa
  - Relat√≥rios completos
  - Configura√ß√£o de chatbots

#### üü° Supervisor
- **Permiss√µes**: Gest√£o de setores e agentes
- **Funcionalidades**:
  - Monitoramento de atendimentos
  - Transfer√™ncia de conversas
  - Relat√≥rios do setor
  - Configura√ß√µes b√°sicas

#### üü¢ Agente
- **Permiss√µes**: Atendimento ao cliente
- **Funcionalidades**:
  - Atendimento via chat
  - Transfer√™ncia de conversas
  - Hist√≥rico de atendimentos
  - Chat interno da equipe

### 2. Criando Usu√°rios

1. **Acesse "Usu√°rios" ‚Üí "Novo Usu√°rio"**

2. **Preencha os dados**:
   ```
   Nome Completo: Jo√£o Silva
   Email: joao@empresa.com
   Cargo: agente
   Setor Principal: Vendas
   Setores Secund√°rios: Suporte (opcional)
   ```

3. **Configura√ß√µes Avan√ßadas**:
   - Capacidade de atendimento simult√¢neo: 3
   - Hor√°rio de trabalho: 08:00-17:00
   - Transfer√™ncia autom√°tica ap√≥s: 30 min
   - Notifica√ß√µes: Ativadas

### 3. Permiss√µes Granulares

#### Por Funcionalidade:
- ‚úÖ Visualizar conversas
- ‚úÖ Responder mensagens
- ‚úÖ Transferir conversas
- ‚ùå Excluir conversas
- ‚ùå Configurar chatbots
- ‚ùå Acessar relat√≥rios

#### Por Setor:
- Agente s√≥ v√™ conversas do seu setor
- Supervisor v√™ todos os setores que gerencia
- Admin v√™ toda a empresa

## üìä Monitoramento e M√©tricas

### 1. Dashboard de Performance

#### M√©tricas Principais:
- **Conversas Ativas**: Em tempo real
- **Tempo M√©dio de Resposta**: Por setor/agente
- **Taxa de Resolu√ß√£o**: Percentual de tickets resolvidos
- **Satisfa√ß√£o do Cliente**: Baseado em feedback

#### Gr√°ficos Dispon√≠veis:
- Volume de mensagens por hora/dia
- Performance por agente
- Distribui√ß√£o por setor
- An√°lise de chatbot (taxa de transfer√™ncia para humanos)

### 2. Queue Monitoring

#### M√©tricas de Fila:
```typescript
interface QueueMetrics {
  tamanhoFila: number;        // Mensagens aguardando processamento
  taxaProcessamento: number;  // Mensagens/minuto
  latenciaMedia: number;      // Tempo m√©dio de processamento
  taxaErro: number;          // % de mensagens falhadas
  dlqCount: number;          // Mensagens na Dead Letter Queue
}
```

#### Alertas Autom√°ticos:
- Fila > 100 mensagens
- Taxa de erro > 5%
- Lat√™ncia > 30 segundos
- DLQ com mensagens

### 3. Logs de Sistema

#### Tipos de Log:
- **Autentica√ß√£o**: Login/logout de usu√°rios
- **Atendimento**: In√≠cio/fim de conversas
- **Webhook**: Eventos da Evolution API
- **Chatbot**: Execu√ß√£o de fluxos
- **Sistema**: Erros e warnings

#### Acesso aos Logs:
1. Painel Super Admin ‚Üí "Logs"
2. Filtros dispon√≠veis:
   - Data/hora
   - Tipo de evento
   - Usu√°rio
   - Empresa
   - N√≠vel de severidade

## üîí Backup e Seguran√ßa

### 1. Backup Autom√°tico

#### Configura√ß√£o do Supabase:
- **Backup Di√°rio**: Autom√°tico via Supabase
- **Reten√ß√£o**: 30 dias
- **Localiza√ß√£o**: Multi-regi√£o

#### Backup Manual:
```sql
-- Backup de dados cr√≠ticos
pg_dump --host=db.supabase.co --username=postgres --dbname=postgres > backup.sql
```

### 2. Seguran√ßa da Aplica√ß√£o

#### Medidas Implementadas:
- **RLS**: Habilitado em todas as tabelas
- **JWT**: Tokens com expira√ß√£o autom√°tica
- **HTTPS**: Obrigat√≥rio em produ√ß√£o
- **Rate Limiting**: Prote√ß√£o contra abuse
- **Valida√ß√£o**: Sanitiza√ß√£o de dados de entrada

#### Configura√ß√µes de Seguran√ßa:
```env
# Rate Limiting
RATE_LIMIT_MAX_REQUESTS=100
RATE_LIMIT_WINDOW_MS=60000

# JWT
JWT_EXPIRATION=24h
JWT_REFRESH_EXPIRATION=7d

# CORS
CORS_ORIGIN=https://seu-dominio.com
```

### 3. Auditoria e Compliance

#### Logs de Auditoria:
- Todas as a√ß√µes de usu√°rios s√£o logadas
- Hist√≥rico de altera√ß√µes em dados sens√≠veis
- Acessos por IP e hor√°rio
- Tentativas de acesso n√£o autorizado

#### Compliance LGPD:
- Dados pessoais criptografados
- Direito ao esquecimento implementado
- Logs de acesso a dados pessoais
- Pol√≠tica de reten√ß√£o de dados

## üö® Troubleshooting

### Problemas Comuns

#### 1. WhatsApp n√£o conecta
**Diagn√≥stico**:
```bash
# Verificar status da Evolution API
curl -X GET "https://sua-evolution-api.com/instance/status" \
  -H "apikey: sua-chave"

# Verificar logs do webhook
SELECT * FROM webhook_logs 
WHERE created_at > NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC;
```

**Solu√ß√µes**:
- Verificar credenciais Z-API
- Confirmar webhook configurado
- Testar conectividade de rede
- Verificar certificado SSL

#### 2. Usu√°rios n√£o conseguem acessar
**Diagn√≥stico**:
```sql
-- Verificar usu√°rio
SELECT * FROM auth.users WHERE email = 'usuario@exemplo.com';

-- Verificar perfil
SELECT * FROM profiles WHERE email = 'usuario@exemplo.com';

-- Verificar empresa
SELECT * FROM empresas WHERE id = 'uuid-da-empresa';
```

**Solu√ß√µes**:
- Verificar permiss√µes RLS
- Confirmar cargo do usu√°rio
- Verificar empresa associada
- Resetar senha se necess√°rio

#### 3. Chatbot n√£o responde
**Diagn√≥stico**:
```sql
-- Verificar fluxos ativos
SELECT * FROM chatbot_flows WHERE ativo = true;

-- Verificar sess√µes
SELECT * FROM chatbot_sessions 
WHERE status = 'ativo' 
AND created_at > NOW() - INTERVAL '1 hour';

-- Verificar logs do chatbot
SELECT * FROM chatbot_logs 
WHERE created_at > NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC;
```

**Solu√ß√µes**:
- Verificar se fluxo est√° ativo
- Testar condi√ß√µes de ativa√ß√£o
- Verificar configura√ß√µes de hor√°rio
- Analisar logs de erro

#### 4. Mensagens em tempo real n√£o funcionam
**Diagn√≥stico**:
```javascript
// Verificar conectividade WebSocket no console
const ws = new WebSocket('wss://seu-dominio.com/realtime');
ws.onopen = () => console.log('WebSocket conectado');
ws.onerror = (error) => console.error('Erro WebSocket:', error);

// Verificar presence system
console.log('Usu√°rios online:', presenceState.onlineUsers);
```

**Solu√ß√µes**:
- Verificar se realtime-gateway est√° deployed
- Confirmar configura√ß√µes de SSL/TLS
- Testar conectividade de rede
- Verificar logs do Edge Functions

### Logs √öteis

#### 1. Logs de Autentica√ß√£o
```sql
SELECT 
  au.email,
  au.created_at as login_time,
  au.last_sign_in_at,
  p.nome,
  p.cargo,
  e.nome as empresa
FROM auth.users au
JOIN profiles p ON au.id = p.id
JOIN empresas e ON p.empresa_id = e.id
WHERE au.email = 'usuario@exemplo.com';
```

#### 2. Logs de Chatbot
```sql
SELECT 
  cl.*,
  cf.nome as fluxo_nome,
  c.id as conversa_id
FROM chatbot_logs cl
JOIN chatbot_flows cf ON cl.flow_id = cf.id
JOIN conversas c ON cl.conversa_id = c.id
WHERE cl.created_at > NOW() - INTERVAL '24 hours'
ORDER BY cl.created_at DESC
LIMIT 50;
```

#### 3. Status das Conex√µes
```sql
SELECT 
  wc.*,
  e.nome as empresa_nome
FROM whatsapp_connections wc
JOIN empresas e ON wc.empresa_id = e.id
WHERE wc.ativo = true
ORDER BY wc.updated_at DESC;
```

#### 4. Performance da Fila
```sql
SELECT 
  message_type,
  COUNT(*) as total,
  AVG(EXTRACT(EPOCH FROM (processed_at - created_at))) as avg_processing_time,
  COUNT(*) FILTER (WHERE status = 'failed') as failed_count
FROM message_queue
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY message_type
ORDER BY total DESC;
```

---

## üìû Suporte T√©cnico

### Contatos:
- **Email**: suporte@ampliemarketing.com
- **WhatsApp**: +55 (11) 99999-9999
- **Discord**: [Comunidade Lovable](https://discord.gg/lovable)

### Hor√°rio de Suporte:
- **Segunda a Sexta**: 8h √†s 18h
- **S√°bado**: 8h √†s 12h
- **Emerg√™ncias**: 24/7 via WhatsApp

### Documenta√ß√£o Adicional:
- [Arquitetura de Tempo Real](REALTIME_ARCHITECTURE.md)
- [Integra√ß√£o Evolution API](EVOLUTION_API_INTEGRATION.md)
- [Seguran√ßa](SECURITY.md)
- [Guia de Testes](TESTING.md)
```